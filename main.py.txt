import os
import time
import requests
from telegram import Bot
from telegram.error import TelegramError

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TELEGRAM_CHAT = os.getenv("TELEGRAM_CHAT")

bot = Bot(token=TELEGRAM_TOKEN)

def send_message(text):
    try:
        bot.send_message(chat_id=TELEGRAM_CHAT, text=text)
        print(f"Sent message: {text}")
    except TelegramError as e:
        print(f"Error sending message: {e}")

def fetch_top_coins():
    url = "https://api.coinmarketcap.com/data-api/v3/cryptocurrency/listing?start=1&limit=200&sortBy=market_cap&sortType=desc"
    try:
        response = requests.get(url)
        data = response.json()
        coins = [coin['symbol'] for coin in data['data']['cryptoCurrencyList']]
        return coins
    except Exception as e:
        print(f"Error fetching coins: {e}")
        return []

def main():
    while True:
        coins = fetch_top_coins()
        # Këtu duhet të implementohet logjika e divergencave RSI për secilin coin në timeframe-t që kërkove
        # Për momentin do dërgojmë vetëm një mesazh test
        send_message(f"Checked {len(coins)} top coins for RSI divergence (placeholder).")
        time.sleep(3600)  # Prit 1 orë para ciklit tjetër

if __name__ == "__main__":
    main()
